<html>

<script src='https://d3js.org/d3.v5.min.js'></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<!-- Load d3-annotation -->
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
<style> circle {fill: lightblue; stroke: black;} </style>
<body onload='init()'>
    <div style="background-color:#1DA1F2;height: 90px;">
        <h1 style="color:white;text-align: center;vertical-align: middle;font-size: 70px;line-height: 100%;">Does Elon Musk Influence Bitcoin Prices?</h1>
    </div>
    <div style="background-color:#1DA1F2;height: 30px;">
        <h1 style="color:white;text-align: center;vertical-align: middle;font-size: 20px;line-height: 100%;">By Vikram Duvvur</h1>
    </div>
    <br>
    
    <div width="100%">
        <button id="play-button" class="btn btn-dark" aria-label="Continue..." style="visibility: hidden" onclick="next_stage()">
            Play
        </button>
        <svg onmouseover="drawTooltip(this)" id="graph" style="display: flex;justify-content: center;display: block; margin: auto" width=600 height=600></svg>
    <div>
    
    <script>
        var data = 0;
        var svg = 0;
        var x = 0;
        var y = 0;
        var stage = 0;
        var path = 0;
        var annotLayer = 0;

        function drawTooltip(x) {
            console.log(d3.event.pageX)
        }

        async function drawLine(path, start, end) {
            var tmp_data = data.filter(function(d,i){ return i >= start && i<end });
            
            path.datum(tmp_data)
                .attr("fill", "none")
                .attr("stroke", "#1DA1F2")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                    .x(function(d,i) {  return x(new Date(d.Date)) })
                    .y(function(d) { return y(d.Price.replace(",","")) })
                );
        }

        async function drawAnimatedLine(start, end) {
            d3.select("#play-button").style("visibility", "hidden");
            var i = start;
            while (i < end) {
                drawLine(path, 0, i);
                await new Promise(r => setTimeout(r, 20));
                i++;
            }
            d3.select("#play-button").style("visibility", "visible");
        }

        async function init() {
            data = await d3.csv("https://raw.githubusercontent.com/vkrd/vkrd.github.io/master/Bitcoin.csv");

            var height_c = 600;
            var width_c = 1500;
            var margin_c = 50;

            //x = d3.scaleLinear().domain([0, 210]).range([0,width_c - 2*margin_c]);
            x = d3.scaleTime().domain([new Date("Jan 01, 2021"), new Date("July 25, 2021")]).range([0,width_c - 2*margin_c]);
            y = d3.scaleLinear().domain([0, 70000]).range([height_c - 2*margin_c,0]);

            svg = d3.select("#graph").attr("height", height_c).attr("width", width_c);
            
            path = svg.append("g").attr("transform","translate(" + margin_c + "," + margin_c + ")")
            .append("path");

            annotLayer = svg.append("g")
            .attr("transform","translate(" + margin_c + "," + margin_c + ")")
            .attr("class", "annotation-group");

            
            svg.append("g")
            .attr("transform","translate("+margin_c+","+margin_c+")")
            .call(d3.axisLeft(y).tickFormat(d3.format("~s")));

            svg.append("g")
            .attr("transform","translate("+margin_c+","+ (height_c - margin_c) + ")")
            .call(d3.axisBottom(x).ticks(d3.timeMonth, 1).tickFormat(d3.timeFormat('%b')));
            
            next_stage();
        }

        async function next_stage() {
            if (stage == 0) {
                d3.select("#play-button").text("Play");
                annotLayer.selectAll("*").remove();
                await drawAnimatedLine(0,84);
                await add_annotations();
                stage++;
            } else if (stage == 1) {
                console.log("starting stage 2");
                await drawAnimatedLine(84,117);
                await add_annotations();
                stage++;
            } else if (stage == 2) {
                console.log("starting stage 3");
                await drawAnimatedLine(117,133);
                await add_annotations();
                stage++;
            } else if (stage == 3) {
                console.log("starting stage 3");
                await drawAnimatedLine(133,209);
                await add_annotations();
                d3.select("#play-button").text("Restart");
                stage++;
            } else {
                stage = 0;
                next_stage();
            }
            
        }

        async function add_annotations() {
            console.log("Adding annotations " + stage);
            var annotations = [];
            if (stage >= 0) {
                annotations.push(
                {
                    note: {
                        title: "March 24, 2021",
                        label: "Elon confirms Tesla will take Bitcoin as payment, price slightly dips"
                    },
                    x: x(new Date("March 24, 2021")),
                    y: y(52325.40),
                    dy: 100,
                    dx: -100
                });
            } 

            if (stage >= 1) { // 
                annotations.push(
                {
                    note: {
                        title: "April 26, 2021",
                        label: "Elon says he has not sold any Bitcoin and Tesla only sold a little, price rises by 10.3%"
                    },
                    x: x(new Date("April 26, 2021")),
                    y: y(54020.50),
                    dy: 100,
                    dx: 20
                });
            }
            if (stage >= 2) {
                annotations.push(
                {
                    note: {
                        title: "May 12, 2021",
                        label: "Elon confirms Tesla no longer accepts Bitcoin, the price drops 12.9% from the previous day's price"
                    },
                    x: x(new Date("May 12, 2021")),
                    y: y(49384.20),
                    dy: -10,
                    dx: 100
                });
            }

            // Add annotation to the chart
            const makeAnnotations = d3.annotation()
            .annotations(annotations);

            annotLayer.call(makeAnnotations);
        }

        </script>
    </body>
</html>