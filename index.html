<html>
<title>Do Elon Musk Tweets Influence Bitcoin Prices?</title>
<script src='https://d3js.org/d3.v5.min.js'></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<!-- Load d3-annotation -->
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
<style> circle {fill: lightblue; stroke: black;} </style>
<body onload='init()'>
    <div style="background-color:#1DA1F2;height: 90px;">
        <h1 style="color:white;text-align: center;vertical-align: middle;font-size: 70px;line-height: 100%;">Do Elon Musk Tweets Influence Bitcoin Prices?</h1>
    </div>
    <div style="background-color:#1DA1F2;height: 30px;">
        <h1 style="color:white;text-align: center;vertical-align: middle;font-size: 20px;line-height: 100%;">By Vikram Duvvur</h1>
    </div>
    <br>
    
    <div width="100%">
        <svg id="graph" style="display: flex;justify-content: center;display: block; margin: auto" width=600 height=600></svg>
        <br><br>
        <button id="play-button" class="btn btn-dark" aria-label="Continue..." style="visibility: hidden;margin:0;
        position: absolute;
        left: 50%;
        -ms-transform: translate(-50%, -90%);
        transform: translate(-50%, -90%);width:10%" onclick="next_stage()">
            Play
        </button>
    <div>
    
    <script>
        var data = 0;
        var svg = 0;
        var x = 0;
        var y = 0;
        var stage = 0;
        var path = 0;
        var annotLayer = 0;
        var focus = 0;
        var focusText = 0;
        var maxPoint = 0;
        var hover = 0;

        var bisect = d3.bisector(function(d) { return new Date(d.Date); }).left;

        async function drawLine(path, start, end) {
            var tmp_data = data.filter(function(d,i){ return i >= start && i<end });
            
            path.datum(tmp_data)
                .attr("fill", "none")
                .attr("stroke", "#1DA1F2")
                .attr("stroke-width", 1.5)
                .attr("d", d3.line()
                    .x(function(d,i) {  return x(new Date(d.Date)) })
                    .y(function(d) { return y(parseFloat(d.Price.replace(",",""))) })
                );
        }

        async function drawAnimatedLine(start, end) {
            d3.select("#play-button").style("visibility", "hidden");
            
            var i = start;
            while (i < end) {
                drawLine(path, 0, i);
                await new Promise(r => setTimeout(r, 20));
                i++;
            }
            maxPoint = end;
            d3.select("#play-button").style("visibility", "visible");
        }

        async function init() {
            data = await d3.csv("https://raw.githubusercontent.com/vkrd/vkrd.github.io/master/Bitcoin.csv");

            var height_c = 600;
            var width_c = 1500;
            var margin_c = 50;

            //x = d3.scaleLinear().domain([0, 210]).range([0,width_c - 2*margin_c]);
            x = d3.scaleTime().domain([new Date("Jan 01, 2021"), new Date("July 25, 2021")]).range([0,width_c - 2*margin_c]);
            y = d3.scaleLinear().domain([15000, 70000]).range([height_c - 2*margin_c,0]);

            svg = d3.select("#graph").attr("height", height_c).attr("width", width_c);
            
            graph = svg.append("g").attr("transform","translate(" + margin_c + "," + margin_c + ")");
            
            path = graph.append("path");

            annotLayer = svg.append("g")
            .attr("transform","translate(" + margin_c + "," + margin_c + ")")
            .attr("class", "annotation-group");

            
            svg.append("g")
            .attr("transform","translate("+margin_c+","+margin_c+")")
            .call(d3.axisLeft(y).tickFormat(d3.format("~s")));

            svg.append("g")
            .attr("transform","translate("+margin_c+","+ (height_c - margin_c) + ")")
            .call(d3.axisBottom(x).ticks(d3.timeMonth, 1).tickFormat(d3.timeFormat('%b %Y')));

            svg.append("text")
            .attr("text-anchor", "end")
            .attr("x", width_c/2 + 16)
            .attr("y", height_c - margin_c*0.2)
            .text("Date");

            // Y axis label:
            svg.append("text")
                .attr("text-anchor", "end")
                .attr("transform", "rotate(-90)")
                .attr("y", 20)
                .attr("x", -height_c/2 +40)
                .text("Price (USD)");
            
                          // Create the circle that travels along the curve of chart
        focus = svg
        
            .append('g')
            .append('circle')
            .style("fill", "none")
            .attr("transform","translate(" + margin_c + "," + margin_c + ")")
            .attr("stroke", "grey")
            .attr('r', 8.5)
            .style("opacity", 0);

        // Create the text that travels along the curve of chart
        focusText = svg
            .append('g')
            .append('text')
            .style("opacity", 0)
            .attr("transform","translate(" + margin_c + "," + margin_c + ")")
            .attr("text-anchor", "left")
            .attr("alignment-baseline", "middle");

        focusText2 = svg
            .append('g')
            .append('text')
            .style("opacity", 0)
            .attr("transform","translate(" + margin_c + "," + margin_c + ")")
            .attr("text-anchor", "left")
            .attr("alignment-baseline", "middle");

        hover = svg.append('g')
            .append('text')
            .style("opacity", 1)
            .attr("transform","translate(" + margin_c*1.2 + "," + margin_c*1.2 + ")")
            .attr("text-anchor", "left")
            .text("Hover over the graph for more details")
            .attr("alignment-baseline", "middle");

            svg
            .append('rect')
            .style("fill", "none")
            .style("pointer-events", "all")
            .attr("transform","translate(" + margin_c + "," + margin_c + ")")
            .attr('width', width_c)
            .attr('height', height_c)
            .on('mouseover', mouseover)
            .on('mousemove', mousemove)
            .on('mouseout', mouseout);

            next_stage();
        }

        async function next_stage() {
            if (stage == 0) {
                d3.select("#play-button").text("Play");
                annotLayer.selectAll("*").remove();
                await drawAnimatedLine(0,84);
                await add_annotations();
                stage++;
            } else if (stage == 1) {
                console.log("starting stage 1");
                await drawAnimatedLine(84,117);
                await add_annotations();
                stage++;
            } else if (stage == 2) {
                console.log("starting stage 2");
                await drawAnimatedLine(117,133);
                await add_annotations();
                stage++;
            } else if (stage == 3) {
                console.log("starting stage 3");
                await drawAnimatedLine(133,165);
                await add_annotations();
                stage++;
            } else if (stage == 4) {
                console.log("starting stage 4");
                await drawAnimatedLine(165,209);
                await add_annotations();
                d3.select("#play-button").text("Restart");
                stage++;
            } else {
                stage = 0;
                maxPoint = 0;
                next_stage();
            }
            
        }

        async function add_annotations() {
            console.log("Adding annotations " + stage);
            var annotations = [];
            if (stage >= 0) {
                annotations.push(
                {
                    note: {
                        title: "March 24, 2021",
                        label: "Elon confirms Tesla will take Bitcoin as payment, price slightly dips by 3.9%"
                    },
                    connector: {
                        end: "dot",        // Can be none, or arrow or dot
                        type: "line"
                    },
                    x: x(new Date("March 24, 2021")),
                    y: y(52325.40),
                    dy: 100,
                    dx: -100
                });
            } 

            if (stage >= 1) { // 
                annotations.push(
                {
                    note: {
                        title: "April 26, 2021",
                        label: "Elon says he has not sold any Bitcoin and Tesla only sold a little, price rises by 10.3%"
                    },
                    connector: {
                        end: "dot",        // Can be none, or arrow or dot
                        type: "line"
                    },
                    x: x(new Date("April 26, 2021")),
                    y: y(54020.50),
                    dy: 100,
                    dx: 20
                });
            }
            if (stage >= 2) {
                annotations.push(
                {
                    note: {
                        title: "May 12, 2021",
                        label: "Elon states Tesla no longer accepts Bitcoin, the price drops 12.9% from the previous day's price"
                    },
                    connector: {
                        end: "dot",        // Can be none, or arrow or dot
                        type: "line"
                    },
                    x: x(new Date("May 12, 2021")),
                    y: y(49384.20),
                    dy: -50,
                    dx: 10
                });
            }
            if (stage >= 3) {
                annotations.push(
                {
                    note: {
                        title: "June 13, 2021",
                        label: "Elon reiterated Tesla has only sold 10% of their Bitcoin, and will resume Bitcoin transactions when it has greater clean energy usage. Price up 10%"
                    },
                    connector: {
                        end: "dot",        // Can be none, or arrow or dot
                        type: "line"
                    },
                    x: x(new Date("June 13, 2021")),
                    y: y(39022.90),
                    dy: -80,
                    dx: 10
                });
            }

            // Add annotation to the chart
            const makeAnnotations = d3.annotation()
            .annotations(annotations);

            annotLayer.call(makeAnnotations);

            annotLayer.selectAll(".connector")
            //.attr('stroke', "blue")
            .style("stroke-dasharray", ("3, 3"));
        }

        function mouseover() {
            focus.style("opacity", 1)
            focusText.style("opacity",1)
            focusText2.style("opacity",1)
            
        }

        function mousemove() {
            // recover coordinate we need
            var x0 = x.invert(d3.mouse(this)[0]);
            var i = bisect(data, x0, 1) - 1;
                if (i < maxPoint - 1) {
                    hover.transition().duration(1500).ease(d3.easeLinear).style("opacity", 0);
                    focus.style("opacity", 1)
                    focusText.style("opacity",1)
                    focusText2.style("opacity",1)

                    selectedData = data[i];

                    focus
                    .attr("cx", x(new Date(selectedData.Date)))
                    .attr("cy", y(parseFloat(selectedData.Price.replace(",",""))));

                    console.log(y(selectedData.Price.replace(",","")));

                    focusText
                    .html((new Date(selectedData.Date)).toLocaleDateString("en-US"))
                    .attr("x", x(new Date(selectedData.Date))+15)
                    .attr("y", y(parseFloat(selectedData.Price.replace(",",""))));

                    focusText2
                    .html("$" + selectedData.Price)
                    .attr("x", x(new Date(selectedData.Date))+5)
                    .attr("y", y(parseFloat(selectedData.Price.replace(",","")))+20);
                } else {
                    focus.style("opacity", 0)
                    focusText.style("opacity",0)
                    focusText2.style("opacity",0)
                }
            }
        function mouseout() {
            focus.style("opacity", 0)
            focusText.style("opacity", 0)
            focusText2.style("opacity", 0)
        }

        </script>
    </body>
</html>
